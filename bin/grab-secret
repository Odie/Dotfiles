#!/usr/bin/env luajit

local function get_env_var(file, var_name)
	for line in file:lines() do
		line = line:match("^%s*(.-)%s*$") -- Trim whitespace

		local raw_value = line:match("^export%s+" .. var_name .. "%s*=%s*(.+)$") -- Bash: export VAR=VALUE
			or line:match("^export%s+" .. var_name .. "%s+(.+)$") -- Fish: export VAR VALUE

		if raw_value then
			local value = raw_value:match('^"(.-)"$') or raw_value:match("^'(.-)'$") or raw_value
			return value
		end
	end

	file:close()
	return nil
end

local function main()
	if #arg ~= 2 then
		print("Usage: grab-secret <secrets_file> <variable_name>")
		os.exit(1)
	end

	local file_path = arg[1]
	local var_name = arg[2]

	-- Can we open the specified file for reading?
	local file = io.open(file_path, "r")
	if not file then
		print("Error: File '" .. file_path .. "' not found!")
		os.exit(1)
	end

	-- Try to retrieve the value from the file
	local var_value = get_env_var(file, var_name)
	if not var_value then
		print("Error: Variable '" .. var_name .. "' not found in file '" .. file_path .. "'.")
		os.exit(1)
	end

	-- Print the retrieved value
	print(var_value)
end

main()
